# AWS IAM Route53 ACME DNS-01 Challenge Module

This Terraform/OpenTofu module creates an IAM user with **least-privilege permissions** for managing Let's Encrypt/ACME DNS-01 challenge TXT records in AWS Route53.

## Features

- **Least-privilege IAM policy**: Restricts `ChangeResourceRecordSets` to only TXT records with `_acme-challenge.` prefix
- **Automatic domain transformation**: Converts input domains (including wildcards) to their corresponding ACME challenge record names
- **Fine-grained Route53 conditions**: Uses `route53:ChangeResourceRecordSetsRecordTypes` and `route53:ChangeResourceRecordSetsNormalizedRecordNames` conditions
- **Compatible with popular ACME clients**: Works with certbot-dns-route53, lego, acme.sh, Traefik, Caddy, and cert-manager
- **Multi-account support**: Supports passing an explicit AWS provider for cross-account Route53 access

## Usage

### Basic Usage

```hcl
module "acme_dns01_user" {
  source = "github.com/GlueOps/opentofu-module-AWS-IAM-route53-ACME-DNS"

  hosted_zone_id   = "Z1234567890ABC"
  user_name        = "acme-dns01-example-com"
  user_description = "ACME DNS-01 challenge user for example.com certificates"

  cert_domains = [
    "*.example.com",
    "example.com",
    "auth.example.com",
    "deep.sub.example.com",
  ]
}

# Use the credentials with your ACME client
output "access_key_id" {
  value = module.acme_dns01_user.access_key_id
}

output "secret_access_key" {
  value     = module.acme_dns01_user.secret_access_key
  sensitive = true
}
```

### Multi-Account Usage (Cross-Account Route53)

When your Route53 hosted zone is in a different AWS account, pass an explicit provider:

```hcl
# Provider for the account where Route53 is hosted
provider "aws" {
  alias  = "route53_account"
  region = "us-east-1"

  assume_role {
    role_arn = "arn:aws:iam::111111111111:role/Route53AdminRole"
  }
}

module "acme_dns01_user" {
  source = "github.com/GlueOps/opentofu-module-AWS-IAM-route53-ACME-DNS"

  providers = {
    aws = aws.route53_account
  }

  hosted_zone_id   = "Z1234567890ABC"
  user_name        = "acme-dns01-example-com"
  user_description = "ACME DNS-01 challenge user for example.com certificates"

  cert_domains = [
    "*.example.com",
  ]
}
```
